---
title: "Projeto Data Mining I"
author: "Lucas Parada, Ana Catarina Monteiro, Lucas de Paula"
date: "11/16/2019"
output: pdf_document
---

# Introdução

# Definição do problema

# Data importation, clean-up and pre-processing
<!-- 
In this part of your work you should focus on importing the provided data into an appropriate R format so
that your posterior analysis is made simpler. You should also check if it is necessary to carry out any data
clean-up and/or pre-processing steps.
-->
## Importando os Dados
Inicialmente importamos todos as bibliotecas que utilizaresmos neste trabalho
Foi importado o dataset "PRSA_Data_Aotizhongxin_20130301-20170228"
&nbsp;
 - Foi utilizado o DataFrame do R para manipular os dados, pois este tipo de estrutura de dados possui um conjunto de funcionalidades e ferrantas que auxiliam neste processo
```{r someVar, echo=FALSE}
suppressMessages(library(na.tools))
suppressMessages(library(naniar))
suppressMessages(library(dplyr))
suppressMessages(library(zoo))
suppressMessages(library(ggplot2))
suppressMessages(library(caret))
suppressMessages(library(tidyimpute))
suppressMessages(library("ggplot2"))
suppressMessages(library(BBmisc))
suppressMessages(library(caret))
suppressMessages(library(mltools))
suppressMessages(library(dataPreparation))
suppressMessages(library(ggExtra))

df <- read.csv('data/PRSA_Data_Aotizhongxin_20130301-20170228.csv')
df  <- tbl_df(df )
color_list <- c('#FF928B', '#FFAC81', '#FFC491', '#EFE8A2', '#CDEAC0')
```
## Analisando os dados
Utilizando a função "summary" da linguagem R foi feita uma análise dos dados.

```{r echo=FALSE}
summary(df)
```
Começamos por verificar se existia algum dia em falta no dataframe e vimos que nao.
Samendo que o dataset possui os valores referentes a 4 anos completos especificados por hora então sevem existir (4*365+1)*24 = 35064 rows

```{r}
  #samendo que o dataset possui os valores referentes a 4 anos completos especificados por hora então sevem existir (4*365+1)*24 = 35064 rows
dim(df)
```


## Outliers
Seguimos com a analise da existencia de outliers em variáveis numericas. Começando por ver fazer a análise por variavel como um todo, em seguida fizemos a análise por variavel tendo em conta a estação do ano e por último por variavel por mês.

### Como um todo
```{r fig.height=4}
col_list = c("CO", "PM2.5", "PM10", "SO2", "NO2", "CO", "O3", "TEMP", "PRES", "DEWP", "RAIN", "WSPM")

df_ALL_boxplot <- df %>% select(col_list)

# remove rows with missing values
df_ALL_boxplot <- df_ALL_boxplot[ complete.cases(df_ALL_boxplot), ]

preproc<-preProcess(df_ALL_boxplot, method=c("range"))
df_ALL_boxplot <- predict(preproc, df_ALL_boxplot)

boxplot(x = df_ALL_boxplot, col = color_list, cex.axis=0.7)

```
Como 

### Por estação do ano
```{r}
col_list <- c("season","CO", "PM2.5", "PM10", "SO2", "NO2", "CO", "O3", "TEMP", "PRES", "DEWP", "RAIN", "WSPM")

df_seasons_boxplot <- df %>% mutate(season = 
  ifelse(month == 12 & day >= 21, 'Winter', 
  ifelse(month == 1 | month == 2, 'Winter', 
  ifelse(month == 3 & day < 20, 'Winter', 
         
  ifelse(month == 3 & day >= 20, 'Spring', 
  ifelse(month == 4 | month == 5, 'Spring', 
  ifelse(month == 6 & day < 21, 'Spring', 
         
  ifelse(month == 6 & day >= 21, 'Summer', 
  ifelse(month == 7 | month == 8, 'Summer', 
  ifelse(month == 9 & day < 21, 'Summer', 
         
  ifelse(month == 9 & day >= 21, 'Autumn', 
  ifelse(month == 10 | month == 11, 'Autumn', 
  ifelse(month == 12 & day < 21, 'Autumn', 
         0))))))))))))
) %>% select(col_list)

#df_seasons_boxplot %>% group_by(season) %>% boxplot(col = color_list, cex.axis=0.7)

for(s in df_seasons_boxplot$season %>% unique()){
  
  df_aux <- df_seasons_boxplot %>% filter(season == s) %>% select(-season)
  
  preproc<-preProcess(df_aux, method=c("range"))
  norm2 <- predict(preproc, df_aux)
  
  norm2 %>% boxplot(main=s, col = color_list, cex.axis=0.7)
  print('')
  
  
}


```

### Por mês
```{r}
col_list = c("month", "CO", "PM2.5", "PM10", "SO2", "NO2", "CO", "O3", "TEMP", "PRES", "DEWP", "RAIN", "WSPM")
df_month_boxplot <- df %>% select(col_list)

month_names <- c("January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December")

for(m in df_month_boxplot$month %>% unique() %>% sort()){
  df_aux <- df_month_boxplot %>% filter(month == m) %>% select(-month)
  
  preproc<-preProcess(df_aux, method=c("range"))
  norm2 <- predict(preproc, df_aux)
  
  par(cxy = c(.5,.5))
  
  norm2 %>% boxplot(main=month_names[m],col = color_list, cex.axis=0.7)
  print('')
}
```


--------------------------------------------------------------------------------------------------------------

## Tratamento de outliers
```{r}
func_quart <- function(val){
  print(val)
  if(is.na(val) )
    return(TRUE)
  
  qr1 <- as.numeric(summary(val)['1rd Qu.'])
  qr3 <- as.numeric(summary(val)['3rd Qu.'])
  
  iqr <- 1.5 * (qr3 - qr1)
  
  if( val>iqr) 
    return(TRUE) 
  
  if( val<-iqr)
     return(TRUE)
  
  return( FALSE )
}

df_preproc <- df

df_preproc <- df_preproc %>% mutate(TEMP =  TEMP+273.15)
#df_preproc$TEMP_dif %>% sort() %>% rev() %>% round() %>% table()
df_preproc <- df_preproc %>% group_by(year, month) %>% 
  mutate(CO =    ifelse(CO >    4*mean(CO, na.rm = T),   NA,  CO)) %>% 
  mutate(PM2.5 = ifelse(PM2.5 > 4*mean(PM2.5, na.rm = T),NA,  PM2.5)) %>% 
  mutate(PM10 =  ifelse(PM10 >  4*mean(PM10, na.rm = T), NA,  PM10)) %>% 
  mutate(SO2 =   ifelse(SO2 >   4*mean(SO2, na.rm = T),  NA,  SO2)) %>% 
  mutate(NO2 =   ifelse(NO2 >   4*mean(NO2, na.rm = T),  NA,  NO2)) %>% 
  mutate(O3 =    ifelse(O3 >    4*mean(O3, na.rm = T),   NA,  O3)) %>% 
  mutate(TEMP =  ifelse(TEMP > 4*mean(TEMP, na.rm = T), NA,  TEMP)) %>% 
  #mutate(TEMP =  ifelse(func_quart(TEMP) == TRUE, NA,  TEMP)) %>% 
  mutate(PRES =  ifelse(PRES >  4*mean(PRES, na.rm = T), NA,  PRES)) %>% 
  mutate(DEWP =  ifelse(abs(DEWP) >  4*abs(mean(DEWP, na.rm = T)), NA,  DEWP)) %>% 
  #mutate(DEWP =  ifelse(DEWP > func_quart(DEWP),  NA,  DEWP)) %>% 
  #mutate(RAIN =  ifelse(RAIN >  4*mean(RAIN, na.rm = T), NA,  RAIN)) %>% 
  #mutate(WSPM =  ifelse(WSPM >  4*mean(WSPM, na.rm = T), NA,  WSPM))  %>%
  ungroup()

df_preproc <- df_preproc %>% mutate(RAIN_cat =  ifelse(RAIN > 0, 1,  0))

  #facet_wrap(~season ) + 
#df_preproc %>% filter(!is.na(TEMP)) %>% ggplot(aes(c(1:nrow( filter(df_preproc, !is.na(TEMP)))*4), TEMP)) + geom_point(size=.05) + 
  #facet_wrap(~month )+ 
  #labs(subtitle="TEMP", title="Jittered Points")

df_preproc <- df_preproc %>% mutate(TEMP =  TEMP-273.15)

```

--------------------------------------------------------------------------------------------------------------


Apartir da análise mencionada anteriormente foi identificada que as varáveis "PM2.5", "PM10", "SO2", "NO2", "CO", "O3", "TEMP", "PRES", "DEWP", "RAIN", "wd", "WSPM" possuem missing values.

Em seguida foi uma análise e foi verificado que as variáveis "TEMP", "PRES", "DEWP", "RAIN" esta a faltar no mesmo dia atravez do gráfico:

Como a variável DEWP possui muitos missings values fizemos um estudo relacionando a varável DEWP e as outras variáveis climaticas para assim tentarmos identificar alguma relação entre elas. Concluimos que existe uma relação direta com a TEMP e uma relação inversa com A variável PRES.

```{r}

#check missing values
#df %>% select(RAIN, TEMP, PRES, wd, WSPM) %>% filter_any_na()
#gg_miss_var(df_preproc)

atm = c("TEMP", "PRES", "DEWP", "RAIN")
# TEMP
theme_set(theme_bw())  # pre-set the bw theme.
ggplot(df_preproc, aes(TEMP, DEWP)) + geom_jitter(width = .5, size=.1) +
  labs(
    title="TEMP",
       subtitle="Relação entre TEMP e DEWP", 
       x="DEWP",
       y="TEMP")+ 
  geom_smooth(method="lm", se=F)

# PRES
ggplot(df_preproc, aes(PRES, DEWP)) + geom_jitter(width = .5, size=.1) +
  labs(
      title="PRES",
       subtitle="Relação entre PRES e DEWP", 
       x="PRES",
       y="DEWP")+ 
  geom_count() + 
  geom_smooth(method="lm", se=F)

# DEWP
ggplot(df_preproc, aes(WSPM, DEWP)) + geom_jitter(width = .5, size=.1) +
  labs(
       title="Jittered Points",
       subtitle="Relação entre WSPM e DEWP", 
       x="WSPM",
       y="DEWP")+ 
  geom_count() + 
  geom_smooth(method="lm", se=F)

# RAIN
ggplot(df_preproc, aes(RAIN, DEWP)) + geom_jitter(width = .5, size=.1) +
  labs(
       title="RAIN",
      subtitle="Relação entre RAIN e DEWP", 
       x="RAIN",
       y="DEWP")+ 
  geom_count() + 
  geom_smooth(method="lm", se=F)

#for(col_name in c('TEMP', 'PRES', 'DEWP', 'RAIN')){
#  (df %>% mutate(test_col = ifelse(is_na(TEMP), 1, 0)))$test_col %>% plot(pch=".", cex=2, main=col_name)  # plot cook's distance
#  abline(h = 4*mean(c(df[col_name]), na.rm=T), col="red")  # add cutoff line
#}

```


### Missing Values
```{r}
df_preproc$PM2.5 <- na.approx(df_preproc$PM2.5, rule=2)
df_preproc$PM10 <- na.approx(df_preproc$PM10, rule=2)
df_preproc$SO2 <- na.approx(df_preproc$SO2, rule=2)
df_preproc$NO2 <- na.approx(df_preproc$NO2, rule=2)
df_preproc$CO <- na.approx(df_preproc$CO, rule=2)
df_preproc$O3 <- na.approx(df_preproc$O3, rule=2)
df_preproc$TEMP <- na.approx(df_preproc$TEMP, rule=2)
df_preproc$PRES <- na.approx(df_preproc$PRES, rule=2)
df_preproc$DEWP <- na.approx(df_preproc$DEWP, rule=2)
df_preproc$WSPM <- na.approx(df_preproc$WSPM, rule=2)
df_preproc <- df_preproc %>% mutate(RAIN_cat = ifelse(is.na(RAIN_cat), 0, RAIN_cat))

#RAIN
#df_preproc$RAIN[which(is.na(df_preproc$RAIN))] <- mode(df_preproc$RAIN)
df_preproc <- df_preproc %>% mutate(RAIN = ifelse(is.na(RAIN), 0, RAIN))
#WD
df_preproc <- transform(df_preproc, wd = na.locf(wd))

#WSPM
#Precisamo verificar como tratar desta variavel(relação entre temperatura e )

#gg_miss_var(df_preproc)
#df_preproc %>% any_na()
```


## Calcular as unidades de medida apropriadas
```{r}
  #massa atomica de atomos utilizados
  o <- 15.999
  n <- 14.007
  c <- 12.011
  s <- 32.06

  #calculando o volume a partir da pressao e da temperatura
  volum_func <- function(t, p){
    return(22.41 * ((t+273.15)/273.15) * 1013/p)
  }

  # conversão de ug/m^3 para ppb
  df_preproc <- df_preproc %>% mutate( CO  = CO  * volum_func(TEMP, PRES) / (c+o) )
  df_preproc <- df_preproc %>% mutate( SO2 = SO2 * volum_func(TEMP, PRES) / (s+o*2) )
  df_preproc <- df_preproc %>% mutate( NO2 = NO2 * volum_func(TEMP, PRES) / (n+o*2) )
  df_preproc <- df_preproc %>% mutate( O3  = O3  * volum_func(TEMP, PRES) / (o*3) )
  
  # conversão de ppb para ppm
  df_preproc <- df_preproc %>% mutate( CO  = CO / 1000 )
  
```

## Calcular a media diaria das variaveis
```{r}

calc_mode <- function(x){
  uniq_x <- unique(x)
  return(uniq_x[which.max(tabulate(match(x, uniq_x)))])
}

df_preproc_sample <- df_preproc %>% group_by(year, month, day) %>% 
      mutate(CO =  mean(CO, na.rm = T)) %>% 
      mutate(PM2.5 =  mean(PM2.5, na.rm = T)) %>% 
      mutate(PM10 = mean(PM10, na.rm = T)) %>%
      mutate(SO2 = mean(SO2, na.rm = T)) %>%
      mutate(NO2 = mean(NO2, na.rm = T)) %>%
      mutate(O3 = mean(O3, na.rm = T)) %>%
      mutate(TEMP = mean(TEMP, na.rm = T)) %>%
      mutate(PRES = mean(PRES, na.rm = T)) %>%
      mutate(DEWP = mean(DEWP, na.rm = T)) %>%
      mutate(RAIN = mean(RAIN, na.rm = T)) %>%
      mutate(WSPM = mean(WSPM, na.rm = T)) %>%
  
      mutate(wd = calc_mode(wd)) %>%
      mutate(RAIN_cat = max(RAIN_cat)) %>%
      ungroup() %>%
      select(-No)  %>% 
      select(-hour) %>% 
      unique()
```

## One Hot Encode da variavel wd
```{r}
dmy  <- dummyVars(" ~wd", data = df_preproc_sample)
trsf <- data.frame(predict(dmy, newdata = df_preproc_sample))

df_preproc_sample <- cbind(df_preproc_sample, trsf)

df$wd %>% unique() %>% sort()
df %>% filter(wd == 'Levels:')

```

## Calcular AQI para cada variavel
```{r}
aqi_table <- read.csv("aqi_table.csv", header = T)
  calc_aqi <- function(c, c_h, c_l){
    ii = 1
    i_h <- aqi_table$AQI_NUM_high
    i_l <- aqi_table$AQI_NUM_low
    
    for(i in c(1:7)){
      if(c_h[i]>=c)
        ii = i
        return(       ((i_h[i] - i_l[i])/(c_h[i] - c_l[i])) * (c - c_l[i]) + i_l[i]     )
    }
    #return( ((i_h[ii] - i_l[ii])/(c_h[ii] - c_l[ii])) * (c - c_l[ii]) + i_l[ii])
  }

  df_preproc_sample <- df_preproc_sample %>% mutate( CO_AQI    =  calc_aqi(CO,aqi_table$CO_high, aqi_table$CO_low) )
  #df_preproc_sample <- df_preproc_sample %>% mutate( PM2.5_AQI =  calc_aqi(PM2.5, aqi_table$PM2.5_high, aqi_table$PM2.5_low) )
  df_preproc_sample <- df_preproc_sample %>% mutate( PM10_AQI  =  calc_aqi(PM10, aqi_table$PM10_high, aqi_table$PM10_low) )
  df_preproc_sample <- df_preproc_sample %>% mutate( SO2_AQI   =  calc_aqi(SO2,aqi_table$SO2_high, aqi_table$SO2_low) )
  df_preproc_sample <- df_preproc_sample %>% mutate( NO2_AQI   =  calc_aqi(NO2,aqi_table$NO2_high, aqi_table$NO2_low) )
  df_preproc_sample <- df_preproc_sample %>% mutate( O3_AQI    =  calc_aqi(O3,aqi_table$O3_high, aqi_table$O3_low) )

```


### Calc a class variable AQI
```{r}
df_preproc_sample[, "AQI"] <- apply( df_preproc_sample[c("PM10_AQI", "SO2_AQI", "NO2_AQI", "CO_AQI", "O3_AQI")], 1,max)

df_preproc_sample <- df_preproc_sample %>% mutate(AQI_cat = 
                                          ifelse(AQI <= 50, 0, 
                                            ifelse(AQI <= 100, 1,
                                              ifelse(AQI <= 150, 2, 
                                                ifelse(AQI <= 200, 3, 
                                                  ifelse(AQI <= 300, 4, 5 ))))))

df_preproc_sample <- df_preproc_sample %>% mutate(AQI_cat_bin = ifelse(AQI <= 150, F, T))

df_preproc_sample <- df_preproc_sample %>% mutate(AQI_poll = 
                                  ifelse(CO_AQI  ==  AQI,  'CO', 
                                    ifelse(SO2_AQI  == AQI, 'SO2',
                                      ifelse(NO2_AQI == AQI, 'NO2', 
                                        #ifelse(O3_AQI == AQI, 'O3', 
                                          ifelse(PM10_AQI == AQI, 'PM10', 'O3' )))))

df_preproc_sample %>% ggplot(aes(c(1:nrow( df_preproc_sample )), AQI)) + 
  geom_point(size=1, aes(colour = cut(AQI, c(-Inf,50, 100, 150, 200, 300, 500, Inf)))) +
  #facet_wrap(~season ) + 
  scale_color_manual(name = "AQI_cat"
                     ,values = c("(-Inf,50]" = "#00e400",
                                  "(50,100]" = "#ffeb3b",
                                  "(100,150]" = "#ff7e00",
                                  "(150,200]" = "#f00f00",
                                  "(200,300]" = "#99004c",
                                  "(300,500]" = "#7e0922",
                                  "(500, Inf]" = "#7e0922")
                     ,labels = c("Good", "Moderate", "Unhealthy for Sensitive Groups", "Unhealthy", "Very Unhealthy", "Hazardous" )) 

```

## calcular a estação do ano
```{r}

# Selecionamos uma sequencia logica para a estação do ano, criando uma escala de de 0 a 3, sendo 0 a mais quente a 3 a mais fria

df_preproc_sample <- df_preproc_sample %>% mutate(season = 
  ifelse(month == 12 & day >= 21, 3, #inverno
  ifelse(month == 1 | month == 2, 3, #inverno 
  ifelse(month == 3 & day < 20, 3, #inverno
         
  ifelse(month == 3 & day >= 20, 1, #primavera
  ifelse(month == 4 | month == 5, 1, #primavera 
  ifelse(month == 6 & day < 21, 1,  #primavera
         
  ifelse(month == 6 & day >= 21, 0,  #verao
  ifelse(month == 7 | month == 8, 0, #verao
  ifelse(month == 9 & day < 21, 0, #verao
         
  ifelse(month == 9 & day >= 21, 2, #outono
  ifelse(month == 10 | month == 11, 2, #outono
  ifelse(month == 12 & day < 21, 2, #outono
         -1)))))))))))))

df_preproc_sample <- df_preproc_sample %>% mutate(season_id = 
  ifelse(month == 12 & day >= 21, 'Winter', 
  ifelse(month == 1 | month == 2, 'Winter', 
  ifelse(month == 3 & day < 20, 'Winter', 
         
  ifelse(month == 3 & day >= 20, 'Spring', 
  ifelse(month == 4 | month == 5, 'Spring', 
  ifelse(month == 6 & day < 21, 'Spring', 
         
  ifelse(month == 6 & day >= 21, 'Summer', 
  ifelse(month == 7 | month == 8, 'Summer', 
  ifelse(month == 9 & day < 21, 'Summer', 
         
  ifelse(month == 9 & day >= 21, 'Autumn', 
  ifelse(month == 10 | month == 11, 'Autumn', 
  ifelse(month == 12 & day < 21, 'Autumn', 
         0)))))))))))))

```



=============================================================================================================
# Analise dos dados

## Por ano

```{r}
df_preproc_sample %>% mutate(year = as.character(year)) %>% ggplot(aes( year, AQI ))+
  #geom_point(size=5, alpha = .1)+
geom_point(size=5, alpha = .3,aes(colour = cut(AQI_cat, c(-Inf, 1, 2, 3, 4, Inf)))) +
  #facet_wrap(~season ) + 
geom_boxplot(alpha = 0) +
scale_color_manual(name = "AQI_cat"
                   ,values = c("(-Inf,1]" = "#00e400",
                                "(1,2]" = "#ffeb3b",
                                "(2,3]" = "#ff7e00",
                                "(3,4]" = "#f00f00",
                                "(4, Inf]" = "#7e0023")
                   ,labels = c("Good", "Moderate", "Unhealthy for Sensitive Groups", "Unhealthy", "Very Unhealthy", "Hazardous" )) 

```


# Data exploratory analysis
<!-- 
This part involves summarising and visualising the data in forms that you think are useful. Try to think
about interesting questions that could be interesting to check with the available data, and provide answers
either using textual summaries or data visualisation.
-->

```{r}
#Aumento do AQI por estação do ano
df_preproc_sample %>% mutate(month_str = 
                        ifelse(month<10,paste("0", as.character(month)), as.character(month) ) ) %>% ggplot(aes( month_str, AQI )) + 
  geom_point(size=5, alpha = .3,aes(colour = cut(AQI_cat, c(-Inf, 1, 2, 3, 4, Inf)))) +
  
  #facet_wrap(~season ) + 
  geom_boxplot(alpha = 0) +
  
  scale_color_manual(name = "AQI_cat"
                     ,values = c("(-Inf,1]" = "#00e400",
                                  "(1,2]" = "#ffeb3b",
                                  "(2,3]" = "#ff7e00",
                                  "(3,4]" = "#f00f00",
                                  "(4, Inf]" = "#7e0023")
                     ,labels = c("Good", "Moderate", "Unhealthy for Sensitive Groups", "Unhealthy", "Very Unhealthy", "Hazardous" )) 



```

```{r}
#Aumento do AQI por estação do ano
df_preproc_sample %>% 
  mutate(season = as.character(season_id)) %>% 
  ggplot(aes( season, AQI )) + 
  geom_point(size=5, alpha = .3,aes(colour = cut(AQI_cat, c(-Inf, 1, 2, 3, 4, Inf)))) +
  geom_boxplot(alpha = 0) +
  scale_color_manual(name = "AQI_cat"
                     ,values = c("(-Inf,1]" = "#00e400",
                                  "(1,2]" = "#ffeb3b",
                                  "(2,3]" = "#ff7e00",
                                  "(3,4]" = "#f00f00",
                                  "(4, Inf]" = "#7e0023")
                     ,labels = c("Good", "Moderate", "Unhealthy for Sensitive Groups", "Unhealthy", "Very Unhealthy", "Hazardous" )) 

```


## dias da semana
```{r}
week_day = 5

df_preproc_sample <- df_preproc_sample %>% mutate(week = 0) 
for(i in c(1: dim(df_preproc_sample)[1])){
  df_preproc_sample$week[i] <- week_day
  week_day <- week_day + 1
  if(week_day>6){
    week_day <-0
  }
}

df_preproc_sample %>% mutate(week = as.character(week)) %>% ggplot(aes( week, AQI ))+
  #geom_point(size=5, alpha = .1)+
geom_point(size=5, alpha = .3,aes(colour = cut(AQI_cat, c(-Inf, 1, 2, 3, 4, Inf)))) +
  #facet_wrap(~season ) + 
geom_boxplot(alpha = 0) +
scale_color_manual(name = "AQI_cat"
                   ,values = c("(-Inf,1]" = "#00e400",
                                "(1,2]" = "#ffeb3b",
                                "(2,3]" = "#ff7e00",
                                "(3,4]" = "#f00f00",
                                "(4, Inf]" = "#7e0023")
                   ,labels = c("Good", "Moderate", "Unhealthy for Sensitive Groups", "Unhealthy", "Very Unhealthy", "Hazardous" )) 
```

```{r}
# Source: Categorical variable.
# mpg$class

pie <- ggplot(df_preproc_sample, aes(x = "", fill = factor(AQI_poll))) + 
  geom_bar(width = 1) +
  theme(axis.line = element_blank(), 
        plot.title = element_text(hjust=0.5)) + 
  labs(fill="class", 
       x=NULL, 
       y=NULL, 
       title="Pie Chart of class", 
       caption="Source: mpg")
  
pie + coord_polar(theta = "y", start=0)
```
## PM10 por hora
```{r}
df_preproc %>% 
    mutate(hour_str = ifelse(hour<10,paste("0", as.character(hour)), as.character(hour) ) ) %>% 
      ggplot(aes( hour_str, PM10 )) +
      geom_point(size=5, alpha = .01, color = c('#74b9ff')) +
      geom_boxplot(alpha = 0)

```


## Relação AQI e PM10
```{r}
g_co <- ggplot(df_preproc_sample, aes(CO_AQI, AQI)) + 
  geom_jitter(alpha=.3, size=.05) +
  labs(
       title="CO",
       subtitle="Relação entre CO e AQI", 
       x="CO",
       y="AQI")+ 
  geom_smooth(method="lm" ) + 
  geom_count()
ggMarginal(g_co, type = "histogram", fill="transparent")

g_so2 <- ggplot(df_preproc_sample, aes(SO2_AQI, AQI)) + 
  geom_jitter(alpha=.3, size=.05) +
  labs(
       title="SO2",
       subtitle="Relação entre SO2 e AQI", 
       x="SO2",
       y="AQI")+ 
  geom_smooth(method="lm" ) + 
  geom_count()
ggMarginal(g_so2, type = "histogram", fill="transparent")

g_no2 <- ggplot(df_preproc_sample, aes(NO2_AQI, AQI)) + 
  geom_jitter(alpha=.3, size=.05) +
  labs(
       title="NO2",
       subtitle="Relação entre NO2 e AQI", 
       x="NO2",
       y="AQI")+ 
  geom_smooth(method="lm" ) + 
  geom_count()
ggMarginal(g_no2, type = "histogram", fill="transparent")

g_o3 <- ggplot(df_preproc_sample, aes(O3_AQI, AQI)) + 
  geom_jitter(alpha=.3, size=.05) +
  labs(
       title="O3",
       subtitle="Relação entre O3 e AQI", 
       x="O3",
       y="AQI")+ 
  geom_smooth(method="lm" ) + 
  geom_count()
ggMarginal(g_o3, type = "histogram", fill="transparent")

# g_pm2.5 <- ggplot(df_preproc_sample, aes(PM2.5_AQI, AQI)) + 
#   geom_jitter(alpha=.3, size=.05) +
#   labs(
#        title="PM2.5",
#        subtitle="Relação entre PM2.5 e AQI", 
#        x="PM2.5",
#        y="AQI")+ 
#   geom_smooth(method="lm" ) + 
#   geom_count()
# ggMarginal(g_pm2.5, type = "histogram", fill="transparent")

g_pm_10 <- ggplot(df_preproc_sample, aes(PM10_AQI, AQI)) + 
  geom_jitter(alpha=.3, size=.5) +
  labs(
       title="PM10",
       subtitle="Relação entre PM10 e AQI", 
       x="PM10",
       y="AQI") + 
  geom_smooth(method="lm" ) + 
  geom_count()
ggMarginal(g_pm_10, type = "histogram", fill="transparent")
```


## Análise pelo velocidade do vento e pela direção
```{r}
#Aumento do AQI por estação do ano
df_preproc_sample %>% 
  ggplot(aes( WSPM, AQI )) + 
  geom_point(size=5, alpha = .3,aes(colour = cut(AQI_cat, c(-Inf, 1, 2, 3, 4, Inf)))) +
  geom_boxplot(alpha = 0) +
  scale_color_manual(name = "AQI_cat"
                     ,values = c("(-Inf,1]" = "#00e400",
                                  "(1,2]" = "#ffeb3b",
                                  "(2,3]" = "#ff7e00",
                                  "(3,4]" = "#f00f00",
                                  "(4, Inf]" = "#7e0023")
                     ,labels = c("Good", "Moderate", "Unhealthy for Sensitive Groups", "Unhealthy", "Very Unhealthy", "Hazardous" )) 



ggplot(df_preproc_sample, aes(WSPM, AQI)) + 
  geom_jitter(alpha=.3, size=.5) +
  facet_wrap(~wd ) + 
  labs(
       title="WSPM",
       subtitle="Relação entre WSPM e AQI", 
       x="WSPM",
       y="AQI") 
```


## Relação AQI e fatores climaticos
```{r}
ggplot(df_preproc_sample, aes(TEMP, AQI)) + 
  geom_jitter(alpha=.3, size=.5) +
  facet_wrap(~season_id ) + 
  labs(
       title="TEMP",
       subtitle="Relação entre TEMP e AQI", 
       x="TEMP",
       y="AQI") + 
  geom_smooth(method="lm" )

ggplot(df_preproc_sample, aes(PRES, AQI)) + 
  geom_jitter(alpha=.3, size=.5) +
  facet_wrap(~season_id ) + 
  labs(
       title="PRES",
       subtitle="Relação entre PRES e AQI", 
       x="PRES",
       y="AQI") + 
  geom_smooth(method="lm" )

ggplot(df_preproc_sample, aes(DEWP, AQI)) + 
  geom_jitter(alpha=.3, size=.5) +
  facet_wrap(~season_id ) + 
  labs(
       title="DEWP",
       subtitle="Relação entre DEWP e AQI", 
       x="WSPM",
       y="AQI") + 
  geom_smooth(method="lm" )
```


-------------------------------------------------------------------
# Predictive modelling
<!-- 
You should define a predictive task that can help to predict the air pollution, through the AQI value or Air
Pollution Level, given its feature values. After defining the task, you should use your available data to select
and obtain a good model for this task. Justify your suggested model.
-->

## installs and imports 
```{r}
#install.packages("tensorflow")
#install.packages("keras")
#install.packages("tfdatasets")

suppressMessages(library(tensorflow))
suppressMessages(library(keras))
suppressMessages(library(tfdatasets))
```

## Normalizar os dados
```{r}
df_norm <- df_preproc_sample %>% select(c("TEMP","PRES","DEWP","RAIN","WSPM","wd.E","wd.ENE","wd.ESE","wd.N","wd.NE","wd.NNE","wd.NNW","wd.NW","wd.S","wd.SE","wd.SSE","wd.SSW","wd.SW","wd.W","wd.WNW","wd.WSW","CO_AQI","PM10_AQI","SO2_AQI","NO2_AQI","O3_AQI", "AQI","season", "RAIN_cat", "month", "AQI_cat_bin"))

preproc <- preProcess(df_norm, method=c("range"))
df_norm <- predict(preproc, df_norm)
#df_norm <- df_norm %>% mutate(AQI_cat = as.factor(AQI_cat))

df_norm <- df_norm*100
df_norm <- df_norm %>% round()
df_norm <- df_norm/100

df_norm['AQI_cat'] <- df_preproc_sample$AQI_cat

df_norm <- df_norm %>% mutate(AQI_cat_prev1 = NA)

for(i in c(2: dim(df_norm)) ){
  df_norm$AQI_cat_prev1[i] <- df_norm$AQI_cat_bin[i-1]
}
df_norm$AQI_cat_prev1[1] <- df_norm$AQI_cat_bin[1]
#sapply(df_preproc, class)
```


## Separar o dataset in training e test
```{r}
  #df_norm_train <- sample(1:nrow(df_norm), 0.8 * nrow(df_norm))
  #df_norm_test <- setdiff(1:nrow(df_norm), df_norm_train)
  
  #x_df_norm_train <- df_norm[df_norm_train, -28]
  #y_df_norm_train <- df_norm[df_norm_train, "AQI_cat"]
  
  #x_df_norm_test <- df_norm[df_norm_test, -28]
  #y_df_norm_test <- df_norm[df_norm_test, "AQI_cat"]
```


## Criar o modelo (rede neuronal)
```{r}
#model <- keras_model_sequential()
#model %>%
#  layer_dense(units = 28) %>%
#  layer_dense(units = 128, activation = 'relu') %>%
#  layer_dropout(0.2) %>% 
#  layer_dense(units = 10, activation = 'softmax')


# COMPILE THE MODEL
#model %>% compile(
#  optimizer = 'adam', 
#  loss = 'sparse_categorical_crossentropy',
#  metrics = c('accuracy')
#)
#colnames(x_df_norm_train)
# TRAIN THE MODEL
#model %>% fit(colnames(x_df_norm_train), x_df_norm_train, epochs = 5, verbose = 2)
```


## Utilizando a biblioteca neuralnet
```{r}
suppressMessages(library(neuralnet))
require(neuralnet)

## 70% of the sample size
smp_size <- floor(0.7 * nrow(df_norm))

## set the seed to make your partition reproducible
set.seed(123)
train_ind <- sample(seq_len(nrow(df_norm)), size = smp_size)

train <- df_norm[train_ind, ]
test <- df_norm[-train_ind, ]

nn <- neuralnet(AQI~TEMP + PRES + DEWP + RAIN + WSPM + wd.E + wd.ENE + wd.ESE + wd.N + wd.NE + wd.NNE + wd.NNW + wd.NW + wd.S + wd.SE + wd.SSE + wd.SSW + wd.SW + wd.W + wd.WNW + wd.WSW + season + AQI_cat_prev1, 
             data=train, hidden=22,act.fct = "logistic",
                linear.output = FALSE)
plot(nn)

Predict=compute(nn,test)
#Predict$net.result

#error <- data.frame(error = (abs(test$AQI - Predict$net.result)))
#error

# Calc the error
error <- data.frame(
  ERROR = (abs(test$AQI_cat - Predict$net.result)),
  real = test$AQI_cat,
  pred = Predict$net.result
  )

error <- error %>% mutate(pred = as.integer(pred) + ifelse(pred - as.integer(pred)>.5, 1, 0)) %>% mutate(accuracy = ifelse(real == pred, 1, 0))

print( paste("Accuracy: ", as.character(sum(error$accuracy)/dim(error)[1]*100), "%", sep = ""))
print(paste("Total error: ", as.character( sum(error$ERROR)/dim(error)[1]*100), sep = ""))
  
ggplot(error, aes(c(1: dim(error)[1]), error$ERROR)) + 
  geom_line(alpha=.3, size=.5) +
  labs(
       title="error",
       x="TEMP",
       y="AQI")

length(error)
```



## Utilizando a biblioteca tree
```{r}
require(tree)
## set the seed to make your partition reproducible
set.seed(123)
smp_size <- floor(0.7 * nrow(df_norm))
train_ind <- sample(seq_len(nrow(df_norm)), size = smp_size)

train <- df_norm[train_ind, ]
test  <- df_norm[-train_ind, ]

tree_aqi <- tree(AQI_cat~ TEMP + PRES + DEWP + RAIN + WSPM + wd.E + wd.ENE + wd.ESE + wd.N + wd.NE + wd.NNE + wd.NNW + wd.NW + wd.S + wd.SE + wd.SSE + wd.SSW + wd.SW + wd.W + wd.WNW + wd.WSW + season + AQI_cat_prev1,
                data=train, split = "gini", control = tree.control(nobs=1500, mincut = 2, minsize=4, mindev = 0.00))

summary(tree_aqi)

plot(tree_aqi)
text(tree_aqi, pretty = 0)

# Calc the error
error <- data.frame(
  ERROR = (abs(test$AQI_cat - predict(tree_aqi, test))),
  real = test$AQI_cat,
  pred = predict(tree_aqi, test)
  )

#plot the error
ggplot(error, aes(c(1: dim(error)[1]))) + 
  geom_line(aes(y = ERROR), color = "red", alpha=.7) + 
  geom_line(aes(y = real), color = "blue", alpha=.7) + 
  geom_line(aes(y = pred), color = "green", alpha=.7) + 
  labs(
       title="error",
       x="TEMP",
       y="AQI")

train %>% group_by(AQI_cat) %>% count()
df_norm %>% group_by(AQI_cat) %>% count()

# Calculate and print accuracy
error <- error %>% mutate(pred = as.integer(pred) + ifelse(pred - as.integer(pred)>.6, 1, 0)) %>% mutate(accuracy = ifelse(real == pred, 1, 0))

print( paste("Accuracy: ", as.character(sum(error$accuracy)/dim(error)[1]*100), "%", sep = ""))
print(paste("Total error: ", as.character( sum(error$ERROR)/dim(error)[1]*100), sep = ""))

table(error$real, error$pred)
```


```{r}
library(ranger)

 #PRES + DEWP + RAIN + WSPM + wd.E + wd.ENE + wd.ESE + wd.N + wd.NE + wd.NNE + wd.NNW + wd.NW + wd.S + wd.SE + wd.SSE + wd.SSW + wd.SW + wd.W + wd.WNW + wd.WSW + season + AQI_cat_prev1

set.seed(123)
smp_size <- floor(0.7 * nrow(df_norm))
train_ind <- sample(seq_len(nrow(df_norm)), size = smp_size)

train <- df_norm[train_ind, ]
test  <- df_norm[-train_ind, ]

forest <- ranger(AQI_cat_bin~  DEWP + wd.E + wd.ENE + wd.ESE + wd.N + wd.NE + wd.NNE + wd.NNW + wd.NW + wd.S + wd.SE + wd.SSE + wd.SSW + wd.SW + wd.W + wd.WNW + wd.WSW + AQI_cat_prev1 + RAIN, 
                 data=train,
                 num.trees = 400,
                 importance = 'impurity',
                 min.node.size = 5,
                 max.depth = 0,
                 seed = 123,
                 classification = TRUE)
## Prediction
pred.forest <- predict(forest, data = test)
table(test$AQI_cat_bin, pred.forest$predictions)

# Calc the error
error <- data.frame(
  real = test$AQI_cat_bin,
  pred =  pred.forest$predictions
  )

error <- error %>% mutate(pred = as.integer(pred) + ifelse(pred - as.integer(pred)>.5, 1, 0)) %>% mutate(accuracy = ifelse(real == pred, 1, 0))

#print(table(error$real, error$pred))
print( paste("Accuracy: ", as.character(sum(error$accuracy)/dim(error)[1]*100), "%", sep = ""))

#forest$variable.importance
#str(forest)
```

## SVM
```{r}
library( e1071 )
library(performanceEstimation)

# set.seed(123)
# smp_size <- floor(0.7 * nrow(df_norm))
# train_ind <- sample(seq_len(nrow(df_norm)), size = smp_size)
# 
# train <- df_norm[train_ind, ]
# test  <- df_norm[-train_ind, ]
# 
# 
# svm_prev <- svm(AQI_cat_bin~  DEWP + wd.E + wd.ENE + wd.ESE + wd.N + wd.NE + wd.NNE + wd.NNW + wd.NW + wd.S + wd.SE + wd.SSE + wd.SSW + wd.SW + wd.W + wd.WNW + wd.WSW + AQI_cat_prev1, data = train)
# 
# 
# print(model)
# summary(model)
res <- performanceEstimation(PredTask(AQI~  DEWP + wd.E + wd.ENE + wd.ESE + wd.N + wd.NE + wd.NNE + wd.NNW + wd.NW + wd.S + wd.SE + wd.SSE + wd.SSW + wd.SW + wd.W + wd.WNW + wd.WSW + AQI_cat_prev1,df_norm),     workflowVariants(learner = "svm", predictor.pars = list(type = "class"), 
    learner.pars = list(kernel = c("linear", "polynomial", "radial", "sigmoid"))), EstimationTask(method = CV()))

summary(res)


pres <- pairedComparisons(res)
signifDiffs(pres)
```










